{% extends "base.html" %}

{% block content %}
<div class="page-container">

    <!-- Profile Header Card -->
    <div class="section-card">
        <div class="profile-header">
            <div class="profile-avatar-wrap">
                {% if user.profile.profile_picture %}
                <img class="profile-avatar profile-avatar--image" src="{{ user.profile.profile_picture.url }}" alt="{{ user.username }} profile picture">
                {% else %}
                <div class="profile-avatar">
                    {{ user.username|slice:":1"|upper }}
                </div>
                {% endif %}
                <form class="profile-avatar-upload" method="post" action="{% url 'upload_profile_picture' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <input class="profile-avatar-upload__input" type="file" name="profile_picture" accept="image/*">
                    <button type="button" class="profile-avatar-upload__button" onclick="this.previousElementSibling.click()">Change</button>
                </form>
            </div>
            <div class="profile-info">
                <h2>{{ user.username }}</h2>
                <span class="profile-role-badge">{{ role|default:"N/A"|title }}</span>
            </div>
        </div>

        <div class="profile-detail-row">
            <span class="profile-label">Email</span>
            <span class="profile-value">{{ user.email|default:"—" }}</span>
        </div>
        <div class="profile-detail-row">
            <span class="profile-label">Joined</span>
            <span class="profile-value">{{ user.date_joined|date:"M d, Y" }}</span>
        </div>
        <div class="profile-detail-row">
            <span class="profile-label">Role</span>
            <span class="profile-value">{{ role|default:"N/A"|title }}</span>
        </div>

        <div class="actions">
            {% if role == "student" %}
            <a class="btn btn-primary" href="{% url 'dashboard' %}">Go to Dashboard</a>
            {% elif role == "lecturer" %}
            <a class="btn btn-primary" href="{% url 'instructor_dashboard' %}">Instructor Dashboard</a>
            {% endif %}
        </div>
    </div>

    <!-- Student Section -->
    {% if role == "student" %}

    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Joined Groups</h2>
        </div>
        <div class="course-grid">
            {% for g in joined_groups %}
            <span class="course-tag">{{ g.name }} &mdash; {{ g.post.title }}</span>
            {% empty %}
            <p class="empty-state">No groups joined.</p>
            {% endfor %}
        </div>
    </div>

    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Upcoming Assignments</h2>
        </div>
        <div class="assignment-list">
            {% for a in upcoming_assignments %}
            <div class="assignment-item">
                <div class="assignment-item-left">
                    <a class="assignment-item-title" href="{% url 'assignment_detail' a.id %}">{{ a.title }}</a>
                    <span class="assignment-course">Due: {{ a.deadline|date:"Y-m-d H:i" }}</span>
                </div>
                {% if a.has_submitted %}
                <span class="badge submitted">Submitted</span>
                {% else %}
                <span class="badge pending">Pending</span>
                {% endif %}
            </div>
            {% empty %}
            <p class="empty-state">No upcoming assignments.</p>
            {% endfor %}
        </div>
    </div>

    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Overdue Assignments</h2>
        </div>
        <div class="assignment-list">
            {% for a in overdue_assignments %}
            <div class="assignment-item">
                <div class="assignment-item-left">
                    <a class="assignment-item-title" href="{% url 'assignment_detail' a.id %}">{{ a.title }}</a>
                </div>
                <span class="badge overdue">Overdue</span>
            </div>
            {% empty %}
            <p class="empty-state">No overdue assignments.</p>
            {% endfor %}
        </div>
    </div>

    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Notifications</h2>
        </div>
        <div class="notification-list">
            {% for n in notifications %}
            <div class="notification-item">{{ n }}</div>
            {% empty %}
            <p class="empty-state">No notifications.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Lecturer Section -->
    {% elif role == "lecturer" %}

    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Courses You Teach</h2>
        </div>
        <div class="course-grid">
            {% for c in courses %}
            <span class="course-tag">{{ c.name }}</span>
            {% empty %}
            <p class="empty-state">No courses assigned.</p>
            {% endfor %}
        </div>
    </div>

    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Assignments You Created</h2>
        </div>
        <div class="assignment-list">
            {% for a in assignments %}
            <div class="assignment-item">
                <div class="assignment-item-left">
                    <a class="assignment-item-title" href="{% url 'assignment_review' a.id %}">{{ a.title }}</a>
                    {% if a.course %}
                    <span class="assignment-course">{{ a.course.name }}</span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p class="empty-state">No assignments created.</p>
            {% endfor %}
        </div>
    </div>

    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Student Submissions</h2>
        </div>
        <div class="row-list">
            {% for s in submissions %}
            <a class="submission-row" href="{% url 'assignment_review' s.post.id %}">
                <div class="submission-left">
                    <span class="submission-student">{{ s.student.username }}</span>
                    <span class="submission-title">{{ s.post.title }}</span>
                </div>
                <span class="submission-date">{{ s.submitted_at|date:"M d, Y · H:i" }}</span>
            </a>
            {% empty %}
            <p class="empty-state">No submissions yet.</p>
            {% endfor %}
        </div>
    </div>

    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Group Management</h2>
        </div>
        <div class="row-list">
            {% for g in groups %}
            <a class="group-row" href="{% url 'group_submission_detail' g.post.id g.id %}">
                <div class="group-left">
                    <span class="group-assignment">{{ g.post.title }}</span>
                    <span class="group-name">{{ g.name }}</span>
                </div>
                <span class="member-badge">{{ g.members.count }} members</span>
            </a>
            {% empty %}
            <p class="empty-state">No groups yet.</p>
            {% endfor %}
        </div>
    </div>

    {% endif %}

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    var input = document.querySelector('.profile-avatar-upload__input');
    if (!input) return;
    input.addEventListener('change', function () {
        if (input.files && input.files.length) {
            input.form.submit();
        }
    });
});
</script>
{% endblock %}
