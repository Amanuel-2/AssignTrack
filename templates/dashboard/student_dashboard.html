{% extends "base.html" %}

{% block content %}
<div class="page-container">
    {% if forbidden %}
    <p class="error-text">Only students can access this dashboard.</p>
    {% else %}

    <div class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Student Dashboard</h1>
            <p class="dashboard-subtitle">Track your assignments, groups, and upcoming deadlines.</p>
        </div>
        <div class="dashboard-profile-card">
            <div class="dashboard-profile-card__identity">
                {% if user.profile.profile_picture %}
                <img class="dashboard-profile-card__avatar" src="{{ user.profile.profile_picture.url }}" alt="{{ user.username }} profile picture">
                {% else %}
                <div class="dashboard-profile-card__avatar dashboard-profile-card__avatar--fallback">
                    {{ user.username|slice:":1"|upper }}
                </div>
                {% endif %}
                <div>
                    <p class="dashboard-profile-card__name">{{ user.get_full_name|default:user.username }}</p>
                    <p class="dashboard-profile-card__hint">Update your profile picture</p>
                </div>
            </div>
            <a class="btn btn-secondary btn-sm" href="{% url 'profile' %}">Manage Profile</a>
        </div>
    </div>

    <!-- Notifications -->
    {% if notifications %}
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Notifications</h2>
        </div>
        <div class="notification-list">
            {% for n in notifications %}
            <div class="notification-item">{{ n }}</div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Find Assignments</h2>
        </div>
        <div class="assignment-tools">
            <div class="assignment-search">
                <span class="assignment-search__icon" aria-hidden="true">&#128269;</span>
                <input type="search" data-asgn-search placeholder="Search by assignment title or course name">
            </div>
            <div class="assignment-filters">
                <button type="button" class="assignment-filter is-active" data-asgn-filter="all">All</button>
                <button type="button" class="assignment-filter" data-asgn-filter="individual">Individual</button>
                <button type="button" class="assignment-filter" data-asgn-filter="group">Group</button>
                <button type="button" class="assignment-filter" data-asgn-filter="completed">Completed</button>
                <button type="button" class="assignment-filter" data-asgn-filter="uncompleted">Uncompleted</button>
                <button type="button" class="assignment-filter" data-asgn-filter="active">Active</button>
                <button type="button" class="assignment-filter" data-asgn-filter="closed">Closed</button>
            </div>
        </div>
    </div>

    <!-- Upcoming Assignments -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Upcoming Assignments</h2>
        </div>
        <div class="assignment-cards-grid js-asgn-grid">
            {% for a in upcoming_assignments %}
            <a class="asgn-card asgn-card--link js-asgn-card"
               href="{% url 'assignment_detail' a.id %}"
               data-title="{{ a.title|lower }}"
               data-course="{{ a.course.name|default:'No Course'|lower }}"
               data-kind="{% if a.group_type == 'individual' %}individual{% else %}group{% endif %}"
               data-completed="{% if a.has_submitted %}true{% else %}false{% endif %}"
               data-state="active">
                <!-- Course + Status -->
                <div class="asgn-card__top">
                    <span class="asgn-card__course-tag">{{ a.course.name|default:"No Course" }}</span>
                    {% if a.has_submitted %}
                    <span class="badge submitted">Submitted</span>
                    {% else %}
                    <span class="badge pending">Not Submitted</span>
                    {% endif %}
                </div>

                <!-- Title -->
                <span class="asgn-card__title">{{ a.title }}</span>

                <!-- Description -->
                <p class="asgn-card__desc">{{ a.content|default:"No description provided."|truncatewords:20 }}</p>

                <!-- Countdown Timer -->
                <div class="asgn-card__timer js-deadline-widget" data-deadline="{{ a.deadline|date:'c' }}">
                    <div class="deadline-circle">
                        <div class="deadline-circle__inner">
                            <span class="deadline-circle__number" data-deadline-number>--</span>
                            <span class="deadline-circle__label" data-deadline-label>Days left</span>
                        </div>
                    </div>
                    <span class="deadline-circle__subtext" data-deadline-inline>Calculating…</span>
                </div>

                <!-- Footer -->
                <div class="asgn-card__footer">
                    <span class="asgn-card__deadline-text">&#128197; {{ a.deadline|date:"M d, Y H:i" }}</span>
                </div>
            </a>
            {% empty %}
            <p class="empty-state">No upcoming assignments.</p>
            {% endfor %}
        </div>
        <p class="empty-state js-filter-empty" hidden>No assignments match the current filters.</p>
    </div>

    <!-- Overdue Assignments -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Overdue Assignments</h2>
        </div>
        <div class="assignment-cards-grid js-asgn-grid">
            {% for a in overdue_assignments %}
            <a class="asgn-card asgn-card--link js-asgn-card"
               href="{% url 'assignment_detail' a.id %}"
               data-title="{{ a.title|lower }}"
               data-course="{{ a.course.name|default:'No Course'|lower }}"
               data-kind="{% if a.group_type == 'individual' %}individual{% else %}group{% endif %}"
               data-completed="{% if a.has_submitted %}true{% else %}false{% endif %}"
               data-state="closed">
                <!-- Course + Status -->
                <div class="asgn-card__top">
                    <span class="asgn-card__course-tag">{{ a.course.name|default:"No Course" }}</span>
                    {% if a.has_submitted %}
                    <span class="badge submitted">Submitted</span>
                    {% else %}
                    <span class="badge overdue">Closed</span>
                    {% endif %}
                </div>

                <!-- Title -->
                <span class="asgn-card__title">{{ a.title }}</span>

                <!-- Description -->
                <p class="asgn-card__desc">{{ a.content|default:"No description provided."|truncatewords:20 }}</p>

                <!-- Countdown Timer (will show Closed) -->
                <div class="asgn-card__timer js-deadline-widget" data-deadline="{{ a.deadline|date:'c' }}">
                    <div class="deadline-circle">
                        <div class="deadline-circle__inner">
                            <span class="deadline-circle__number" data-deadline-number>--</span>
                            <span class="deadline-circle__label" data-deadline-label></span>
                        </div>
                    </div>
                    <span class="deadline-circle__subtext" data-deadline-inline>Calculating…</span>
                </div>

                <!-- Footer -->
                <div class="asgn-card__footer">
                    <span class="asgn-card__deadline-text">&#128197; {{ a.deadline|date:"M d, Y H:i" }}</span>
                </div>
            </a>
            {% empty %}
            <p class="empty-state">No overdue assignments.</p>
            {% endfor %}
        </div>
        <p class="empty-state js-filter-empty" hidden>No assignments match the current filters.</p>
    </div>

    <!-- Joined Groups -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Joined Groups</h2>
        </div>
        <div class="course-grid">
            {% for g in joined_groups %}
            <span class="course-tag">{{ g.name }} &mdash; {{ g.post.title }}</span>
            {% empty %}
            <p class="empty-state">No groups joined.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Assignment Workspace -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Assignment Workspace</h2>
        </div>
        <div class="assignment-cards-grid js-asgn-grid">
            {% for post in posts %}
            <a class="asgn-card asgn-card--link js-asgn-card"
               href="{% url 'assignment_detail' post.id %}"
               data-title="{{ post.title|lower }}"
               data-course="{{ post.course.name|default:'No Course'|lower }}"
               data-kind="{% if post.group_type == 'individual' %}individual{% else %}group{% endif %}"
               data-completed="{% if post.user_status == 'Submitted' %}true{% else %}false{% endif %}"
               data-state="{% if post.is_overdue %}closed{% else %}active{% endif %}">
                <!-- Course + Status -->
                <div class="asgn-card__top">
                    <span class="asgn-card__course-tag">{{ post.course.name|default:"No Course" }}</span>
                    <span class="badge {{ post.status_class }}">{{ post.user_status }}</span>
                </div>

                <!-- Title -->
                <span class="asgn-card__title">{{ post.title }}</span>

                <!-- Description -->
                <p class="asgn-card__desc">{{ post.content|default:"No description provided."|truncatewords:20 }}</p>

                <!-- Countdown Timer -->
                <div class="asgn-card__timer js-deadline-widget" data-deadline="{{ post.deadline|date:'c' }}">
                    <div class="deadline-circle">
                        <div class="deadline-circle__inner">
                            <span class="deadline-circle__number" data-deadline-number>--</span>
                            <span class="deadline-circle__label" data-deadline-label>Days left</span>
                        </div>
                    </div>
                    <span class="deadline-circle__subtext" data-deadline-inline>Calculating…</span>
                </div>

                <!-- Footer: deadline + instructor -->
                <div class="asgn-card__footer">
                    <div class="asgn-card__meta">
                        <span class="asgn-card__deadline-text">&#128197; {{ post.deadline|date:"M d, Y H:i" }}</span>
                        <span class="text-muted">{{ post.author.get_full_name|default:post.author.username }}</span>
                        {% if post.user_group %}
                        <span class="text-muted">{{ post.user_group }}</span>
                        {% endif %}
                    </div>
                </div>
            </a>
            {% empty %}
            <p class="empty-state">No assignments found.</p>
            {% endfor %}
        </div>
        <p class="empty-state js-filter-empty" hidden>No assignments match the current filters.</p>
    </div>

    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    var widgets = document.querySelectorAll('.js-deadline-widget');

    function updateWidget(widget) {
        var iso = widget.getAttribute('data-deadline');
        var deadline = new Date(iso);
        if (!iso || isNaN(deadline.getTime())) return;

        var numEl    = widget.querySelector('[data-deadline-number]');
        var labelEl  = widget.querySelector('[data-deadline-label]');
        var inlineEl = widget.querySelector('[data-deadline-inline]');

        var now    = new Date();
        var diffMs = deadline - now;

        // Remove all urgency classes
        widget.classList.remove('is-closed', 'is-warning', 'is-urgent');

        if (diffMs <= 0) {
            widget.classList.add('is-closed');
            if (numEl)    numEl.textContent   = 'Closed';
            if (labelEl)  labelEl.textContent  = '';
            if (inlineEl) inlineEl.textContent = 'Deadline has passed';
            return;
        }

        var totalSeconds = Math.floor(diffMs / 1000);
        var days    = Math.floor(totalSeconds / 86400);
        var hours   = Math.floor((totalSeconds % 86400) / 3600);
        var minutes = Math.floor((totalSeconds % 3600) / 60);

        // Apply urgency classes
        if (totalSeconds < 86400) {
            widget.classList.add('is-urgent');       // < 24 hours
        } else if (days < 3) {
            widget.classList.add('is-warning');      // < 3 days
        }

        if (days > 0) {
            if (numEl)   numEl.textContent  = String(days);
            if (labelEl) labelEl.textContent = days === 1 ? 'Day left' : 'Days left';
        } else if (hours > 0) {
            if (numEl)   numEl.textContent  = String(hours);
            if (labelEl) labelEl.textContent = hours === 1 ? 'Hour left' : 'Hours left';
        } else {
            if (numEl)   numEl.textContent  = String(Math.max(minutes, 0));
            if (labelEl) labelEl.textContent = minutes === 1 ? 'Min left' : 'Mins left';
        }

        if (inlineEl) inlineEl.textContent = days + 'd ' + hours + 'h ' + minutes + 'm remaining';
    }

    function tick() {
        widgets.forEach(updateWidget);
    }

    if (widgets.length) {
        tick();
        setInterval(tick, 60000);
    }

    var searchInput = document.querySelector('[data-asgn-search]');
    var filterButtons = document.querySelectorAll('[data-asgn-filter]');
    var cards = document.querySelectorAll('.js-asgn-card');
    var grids = document.querySelectorAll('.js-asgn-grid');
    var activeFilter = 'all';

    function matchesFilter(card, filterName) {
        if (filterName === 'all') return true;
        if (filterName === 'individual') return card.dataset.kind === 'individual';
        if (filterName === 'group') return card.dataset.kind === 'group';
        if (filterName === 'completed') return card.dataset.completed === 'true';
        if (filterName === 'uncompleted') return card.dataset.completed === 'false';
        if (filterName === 'active') return card.dataset.state === 'active';
        if (filterName === 'closed') return card.dataset.state === 'closed';
        return true;
    }

    function applyAssignmentFilters() {
        var searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';

        cards.forEach(function (card) {
            var title = card.dataset.title || '';
            var course = card.dataset.course || '';
            var searchMatch = !searchTerm || title.indexOf(searchTerm) !== -1 || course.indexOf(searchTerm) !== -1;
            var filterMatch = matchesFilter(card, activeFilter);
            card.style.display = (searchMatch && filterMatch) ? '' : 'none';
        });

        grids.forEach(function (grid) {
            var visibleCount = Array.from(grid.querySelectorAll('.js-asgn-card'))
                .filter(function (card) { return card.style.display !== 'none'; }).length;
            var emptyForFilter = grid.parentElement.querySelector('.js-filter-empty');
            if (emptyForFilter) {
                emptyForFilter.hidden = visibleCount !== 0;
            }
        });
    }

    if (searchInput) {
        searchInput.addEventListener('input', applyAssignmentFilters);
    }

    filterButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            activeFilter = button.getAttribute('data-asgn-filter') || 'all';
            filterButtons.forEach(function (b) { b.classList.remove('is-active'); });
            button.classList.add('is-active');
            applyAssignmentFilters();
        });
    });

    applyAssignmentFilters();
});
</script>
{% endblock %}
